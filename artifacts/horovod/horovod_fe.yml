---
- hosts: localhost
  connection: local
  vars:
     vnode_prefix: vnode-
  roles:
    - role: grycap.nfs
      nfs_mode: 'front'
      nfs_exports: [{path: "/home", export: "{{ vnode_prefix }}*.localdomain(rw,async,no_root_squash,no_subtree_check,insecure,crossmnt)"}]
    - role: 'grycap.ssh'
      ssh_type_of_node: 'front'
      ssh_user: horovod
  tasks:
    - name: Install system dependencies in Debian
      apt:
        pkg:
          - python3
          - python3-dev
          - openmpi-bin
          - openmpi-common
          - libopenmpi-dev
          - gcc
          - g++
          - make
          - cmake
          - python3-pip
        state: present
      when: ansible_os_family == "Debian"

    - name: Install epel in RedHat
      package:
        name: epel-release
        state: present
      when: ansible_os_family == "RedHat"

    - name: Install system dependencies in RedHat
      package:
        name:
          - python3
          - python3-devel
          - gcc
          - gcc-c++
          - make
          - cmake
          - python3-pip
          - openmpi
          - openmpi-devel
        state: present
      when: ansible_os_family == "RedHat"

    - name: Install python dependencies
      pip:
        name:
          - tensorflow
          - keras
        state: present
        executable: pip3
      environment:
        # This is only needed for RedHat
        PATH: "{{ ansible_env.PATH }}:/usr/lib64/openmpi/bin"

    - name: Install horovod
      pip:
        name: horovod
        state: present
        executable: pip3
        extra_args: --no-binary horovod
      environment:
        HOROVOD_WITH_MPI: 1
        # This is only needed for RedHat
        PATH: "{{ ansible_env.PATH }}:/usr/lib64/openmpi/bin"